# Project Index: AIDocMaster (EcritisAgent)

> Auto-generated by project-indexer | Last updated: 2026-02-25

## Project Overview

- **Type:** Fullstack Desktop Application
- **Languages:** TypeScript (60%), Python (40%)
- **Frameworks:** Next.js 16, React 19, Flask 3.0, LangChain, LangGraph, Electron 28
- **Entry Points:** `app/page.tsx`, `backend/app.py`, `electron/main.js`
- **Purpose:** AI-powered document creation, editing, and intelligent assistant with multi-agent orchestration + autonomous coding agent (pi-agent)

## Feature Map

### Pi-Agent Coding Mode (`app/api/agent-chat/`, `lib/agent*.ts`)
Entry: `app/api/agent-chat/route.ts`
- Autonomous coding agent using `@mariozechner/pi-agent-core` / `@mariozechner/pi-coding-agent`
- Agent runs in a user-selected working directory with full file I/O and shell access
- **Key exports:**
  - `POST /api/agent-chat` — Runs the pi-agent loop, streams `AgentEvent` SSE back to the client
  - `GET /api/agent-chat/home-dir` — Returns the user's home directory as default workDir
  - `POST /api/agent-chat/validate-dir` — Validates and resolves a directory path
  - `GET /api/agent-file` — Downloads files created/modified by the agent (with path traversal protection)
  - `createAgentTools(workDir)` (`lib/agentTools.ts`) — Factory for coding tools (read, bash, edit, write, grep, find, ls) bound to workDir
  - `adaptModelToLlm(model)` (`lib/agentLlmAdapter.ts`) — Bridges ModelConfig to pi-ai Model + StreamOptions
  - `parseAgentStream(stream, callbacks)` (`lib/agentStreamParser.ts`) — Parses agent SSE stream on frontend
  - `mapAgentEventToSSE(event)` (`lib/agentEventMapper.ts`) — Converts AgentEvent → SSE frame payloads
  - `AgentExecutionBlock` types (`lib/agentExecutionBlock.ts`) — Discriminated union for timeline steps
  - `loadAgentConfig()` / `saveAgentWorkDir()` (`lib/agentConfig.ts`) — Working dir persistence in localStorage

### Multi-Agent AI System (`backend/agent/`)
Entry: `backend/agent/agent_router.py`
- LangGraph-powered document creation and modification orchestrated via intent routing
- **Key exports:**
  - `AgentRouter.route_to_agent()` — Routes user requests to AutoWriter or DocumentModifier
  - `AutoWriterAgent` — Generates documents from scratch (outline → parallel section drafting → refinement)
  - `DocumentModifierAgent` — Modifies existing documents (plan → execute tools → summarize)
  - `DocumentTools` — `search_document_paragraphs`, `modify_document_paragraph`
  - `AgentState` — TypedDict state structure for LangGraph workflows

### UI Components (`components/`)
Entry: `components/Container.tsx`
- React UI components for taskbar-based multi-task interface
- **Key components:**
  - `Container` — Main app wrapper with taskbar and feature switching
  - `Taskbar` — Vertical navigation with task icons
  - `AIChatContainer` — Multi-conversation chat with streaming and pi-agent integration
  - `AIAutoWriterContainer` — Document generation from natural language
  - `AIDocValidationContainer` — Document editor with AI modification
  - `WordEditorPanel` — TipTap v3 WYSIWYG editor
  - `AgentToggle` — Toggle for enabling/disabling pi-agent mode in chat
  - `AgentWorkDirBar` — Displays current working directory with validity indicator
  - `AgentWorkDirDialog` — Modal for selecting working directory (Electron native → fallback)
  - `AgentExecutionTimeline` — Vertical timeline of agent execution blocks
  - `AgentToolCallDisplay` — Expandable tool call details (input, status, result)
  - `AgentThinkingIndicator` — "Agent is thinking..." animation
  - `AgentFileOutputCard` — Cards for files created/modified by agent with download
  - `AgentSettingsPanel` — Settings panel for default work dir and recent dirs
  - `SettingsContainer` / `SettingsDialog` — Full settings UI with sidebar navigation
  - `ChatMessage` — Message display with markdown and syntax highlighting
  - `ChatInput` — Input with file attachment and MCP tool selection
  - `MCPToolSelector` / `MCPToolExecutionDisplay` — MCP tool selection and result display

### Next.js API Routes (`app/api/`)
Entry: `app/api/chat/route.ts`
- Proxy layer to Flask backend (streaming) + pi-agent routes (server-side)
- **Key routes:**
  - `/api/chat` — Stream chat with LLM (Flask proxy)
  - `/api/agent-validation` — Document modification agent (Flask proxy)
  - `/api/auto-writer` — Document generation agent (Flask proxy)
  - `/api/agent-route` — Intelligent agent routing (Flask proxy)
  - `/api/models` — LLM model configuration CRUD (Flask proxy)
  - `/api/agent-chat` — Pi-agent coding loop (server-side, uses pi-agent-core)
  - `/api/agent-chat/home-dir` — Home directory utility
  - `/api/agent-chat/validate-dir` — Directory validation
  - `/api/agent-file` — File download for agent outputs

### Utility Libraries (`lib/`)
Entry: `lib/apiConfig.ts`
- **Key exports:**
  - `buildApiUrl(endpoint)` — Builds API URLs for dev/prod/Electron (always use this)
  - `logger` — Custom structured logging (use instead of console.log)
  - `chatStorage` — LocalStorage chat history persistence
  - `loadModelConfigsByType(type)` / `saveModelConfigsByType(type, data)` — Per-type model CRUD
  - `getLLMConfigFromModel(m)` — Resolves full call config from a ModelConfig
  - `isStandardModel(m)` / `isCodingPlanModel(m)` / `isCustomModel(m)` — Type guards
  - `getModelApiUrl(m)` / `getModelName(m)` — Type-safe field accessors
  - `loadProviders()` — Read-only provider templates
  - `LanguageProvider` / `useLanguage()` / `getDictionary(locale)` — i18n (EN/ZH)
  - `cn(classes)` — Tailwind class merger

### Backend Domain Services (`backend/domains/`)
Entry: `backend/app.py`
- DDD architecture with Flask blueprints
- **Domains:**
  - `chat/` — Chat with LLM, streaming SSE (blueprint: `chat_bp`)
  - `agent/` — Agent routing and execution (blueprint: `agent_bp`)
  - `document/` — Document parsing Word/PDF (blueprint: `document_bp`)
  - `model/` — LLM model configuration CRUD, per-type and cross-type endpoints (blueprint: `model_bp`)
  - `mcp/` — MCP server management (blueprint: `mcp_bp`)
  - `image_service/` — Image generation integration (blueprint: `image_service_bp`)
  - `search_service/` — Web search providers Tavily/Baidu (blueprint: `search_service_bp`)
  - `system/` — Health check and logs at `/health` and `/api/logs` (blueprint: `system_bp`)

### Protocol-Aware LLM Factory (`backend/llm_factory.py`)
- `create_llm_client(call_config)` — LangChain chat model for agent workflows
- `build_http_request(call_config, messages)` — Raw HTTP request for streaming pass-through
- `iter_anthropic_as_openai_sse(response)` — Converts Anthropic SSE to OpenAI format
- Protocol dispatch: `protocol: 'openai'` → `ChatOpenAI`; `protocol: 'anthropic'` → `ChatAnthropic`

### ConfigLoader (`backend/app.py`)
- `load_models_by_type(type)` / `save_models_by_type(type, data)` — Per-type storage
- `get_llm_config(model_id)` — Resolves full call_config merging provider templates
- `set_default_model(model_id)` — Cross-file default
- `load_providers()` — Read-only `backend/config/providers.json`

### Electron Desktop Packaging (`electron/`)
Entry: `electron/main.js`
- Desktop app main process with Flask subprocess management
- **Key files:**
  - `main.js` — Window creation, IPC handlers, spawns Flask backend
  - `flask-launcher.js` — Flask subprocess with dynamic port allocation
  - `api-server.js` — API server for packaged mode (serves Next.js output)
  - `preload.js` — IPC bridge exposing `window.electronAPI`

## Module Dependencies

**Frontend:**
- `components` → `lib` (logger, apiConfig, chatClient, modelConfig, agentConfig)
- `app/api/agent-chat` → `lib` (agentTools, agentEventMapper)
- `app/api/*` (Flask proxies) → `lib/apiConfig` (buildApiUrl)
- `app/page.tsx` → `components/Container`

**Backend:**
- `domains` → `agent` (AgentRouter, AutoWriterAgent, DocumentModifierAgent)
- `agent` → `mcp_client`, LangChain, LangGraph
- `app.py` → all domain blueprints + ConfigLoader + llm_factory

**Desktop:**
- `electron/main.js` → `backend/app.py` (spawns as subprocess)
- `electron/main.js` → `out/` (serves Next.js production build)

## File Index

### components/
| File | Description |
|------|-------------|
| Container.tsx | Main app container with taskbar and feature switching |
| Taskbar.tsx | Vertical navigation bar with task icons |
| AIChatContainer.tsx | Multi-conversation chat with streaming and pi-agent mode |
| AIAutoWriterContainer.tsx | Document auto-generation from natural language prompts |
| AIDocValidationContainer.tsx | Document editor with AI-powered modification |
| ChatMessage.tsx | Message display with markdown, syntax highlighting, citations |
| ChatInput.tsx | Chat input with file attachment and MCP tool selection |
| ChatStopButton.tsx | Stop button for streaming responses |
| WordEditorPanel.tsx | TipTap v3 WYSIWYG editor |
| AgentToggle.tsx | Toggle switch for enabling/disabling pi-agent mode |
| AgentWorkDirBar.tsx | Working directory display with validity indicator |
| AgentWorkDirDialog.tsx | Modal for selecting agent working directory |
| AgentExecutionTimeline.tsx | Vertical timeline of agent execution blocks |
| AgentToolCallDisplay.tsx | Expandable tool call details (input, status, result) |
| AgentThinkingIndicator.tsx | "Agent is thinking..." animation |
| AgentFileOutputCard.tsx | Cards for agent-created/modified files with download |
| AgentSettingsPanel.tsx | Settings panel for default work dir and recent dirs |
| AgentStatusPanel.tsx | Agent execution status and progress |
| AgentListDialog.tsx | Available agents list dialog |
| SettingsContainer.tsx | Full-page settings with sidebar navigation |
| SettingsDialog.tsx | Settings modal with tabbed panels |
| ModelSettingsPanel.tsx | LLM model configuration (3-tab: standard/codingPlan/custom) |
| MCPSettingsPanel.tsx | MCP server configuration panel |
| MCPToolSelector.tsx | Multi-select MCP tool selector for chat |
| MCPToolExecutionDisplay.tsx | MCP tool execution results display |
| SearchServiceSettingsPanel.tsx | Web search provider configuration |
| ImageServiceSettingsPanel.tsx | Image generation service configuration |
| DisplaySettingsPanel.tsx | UI display preferences (font size, etc.) |
| ConversationList.tsx | Chat conversation sidebar with search |
| NewConversationDialog.tsx | New conversation creation dialog |
| ChatBotManager.tsx | Chat bot configuration and management |
| ValidationResultPanel.tsx | Agent validation results display |
| RewriteComparisonView.tsx | Side-by-side comparison for AI rewrites |
| TextSelectionToolbar.tsx | Floating toolbar for text selection |
| TextCheckResultView.tsx | Text validation results display |
| NetworkSearchToggle.tsx | Toggle for web search in chat |
| NetworkSearchExecutionDisplay.tsx | Web search results display |
| ImageInsertDialog.tsx | Image insertion dialog for editor |
| ImageEditor.tsx | Image editing and manipulation |
| ImageEditorPanel.tsx | Image editor panel container |
| ThemeToggle.tsx | Light/dark theme toggle |
| LanguageSwitcher.tsx | Language switching (EN/ZH) |
| FloatingChatButton.tsx | Floating chat button overlay |
| ConfirmDialog.tsx | Confirmation dialog |
| ErrorDialog.tsx | Error display dialog |
| InfoDialog.tsx | Information dialog |
| ContextMenu.tsx | Right-click context menu |
| ChatDialog.tsx | Chat dialog modal |
| ChatPanel.tsx | Chat panel container |
| ChatErrorDisplay.tsx | Chat error message display |
| FileAttachment.tsx | File attachment display and handling |
| Header.tsx | Application header |
| Footer.tsx | Application footer |

### app/
| File | Description |
|------|-------------|
| page.tsx | Main application page — renders Container |
| layout.tsx | Root layout with theme provider and i18n setup |
| globals.css | Global CSS variables and Tailwind base styles |
| api/chat/route.ts | Chat API proxy to Flask with SSE streaming |
| api/agent-validation/route.ts | Document validation agent proxy |
| api/auto-writer/route.ts | Document auto-writer agent proxy |
| api/agent-route/route.ts | Agent routing proxy |
| api/models/route.ts | Model configuration CRUD proxy |
| api/agents/route.ts | Agent list and info proxy |
| api/document-validation/route.ts | Document validation proxy |
| api/text-processing/route.ts | Text processing proxy |
| api/agent-chat/route.ts | Pi-agent coding loop (server-side) |
| api/agent-chat/home-dir/route.ts | Returns user home directory |
| api/agent-chat/validate-dir/route.ts | Validates and resolves a directory path |
| api/agent-file/route.ts | File download for agent-created files |

### lib/
| File | Description |
|------|-------------|
| apiConfig.ts | API URL builder for dev/prod/Electron (exports: buildApiUrl, getApiBaseUrl) |
| chatClient.ts | LLM chat client with streaming (exports: getLLMConfig, validateLLMConfig) |
| logger.ts | Custom structured logging (exports: logger with info/error/debug/success) |
| utils.ts | Utilities (exports: cn — Tailwind class merger) |
| chatStorage.ts | LocalStorage chat history (exports: saveConversations, loadConversations) |
| modelConfig.ts | Model config with discriminated union types and type guards |
| modelConfigServer.ts | Server-side model config sync |
| modelConfigSync.ts | Model config synchronization utilities |
| agentConfig.ts | Pi-agent working dir persistence (exports: loadAgentConfig, saveAgentWorkDir, loadRecentDirs) |
| agentTools.ts | Pi-agent tool factory (exports: createAgentTools(workDir)) |
| agentEventMapper.ts | AgentEvent → SSE frame payloads (exports: mapAgentEventToSSE, encodeSSE, errorToSSE) |
| agentStreamParser.ts | Frontend SSE parser for agent events (exports: parseAgentStream) |
| agentLlmAdapter.ts | Bridges ModelConfig to pi-ai Model + StreamOptions (exports: adaptModelToLlm) |
| agentExecutionBlock.ts | Discriminated union types for agent timeline steps |
| mcpConfig.ts | MCP server configuration (exports: loadMCPConfig, saveMCPConfig) |
| imageServiceConfig.ts | Image service configuration |
| searchServiceConfig.ts | Search service configuration |
| displayConfig.ts | Display settings configuration |
| chatBotConfig.ts | Chat bot configuration |
| flaskConfig.ts | Flask backend configuration utilities |
| documentUtils.ts | Document processing (exports: parseWordDocument, exportToWord) |
| wordExport.ts | Word export with formatting (exports: exportToDocx) |
| textProcessingApi.ts | Text processing API client |
| highlightExtension.ts | TipTap highlight extension |
| highlightUtils.ts | Syntax highlighting utilities |
| imageExtension.ts | TipTap image extension with resize |
| i18n/config.ts | i18next configuration |
| i18n/dictionaries.ts | Translation dictionaries EN/ZH (exports: getDictionary, Dictionary type) |
| i18n/LanguageContext.tsx | Language context (exports: LanguageProvider, useLanguage) |

### backend/agent/
| File | Description |
|------|-------------|
| agent_router.py | Routes requests to AutoWriter or DocumentModifier (exports: AgentRouter) |
| auto_writer_agent.py | Generates documents from scratch (exports: AutoWriterAgent) |
| document_agent.py | Modifies existing documents (exports: DocumentModifierAgent) |
| writer_intent.py | Intent detection (exports: WriterIntent, extract_writer_intent) |
| tools.py | Document manipulation tools (exports: DocumentTools) |
| prompts.py | LLM prompts (exports: ROUTER_PROMPT, AUTO_WRITER_PROMPT, DOCUMENT_MODIFIER_PROMPT) |
| state.py | Agent state definitions (exports: AgentState, TodoItem) |

### backend/domains/
| Domain | Routes | Description |
|--------|--------|-------------|
| chat/ | routes.py | Chat streaming SSE (blueprint: chat_bp) |
| agent/ | routes.py | Agent routing and execution (blueprint: agent_bp) |
| document/ | routes.py, parser.py | Document parsing Word/PDF (blueprint: document_bp) |
| model/ | routes.py | Model config CRUD with per-type endpoints (blueprint: model_bp) |
| mcp/ | routes.py | MCP server management (blueprint: mcp_bp) |
| image_service/ | routes.py | Image generation (blueprint: image_service_bp) |
| search_service/ | routes.py | Web search Tavily/Baidu (blueprint: search_service_bp) |
| system/ | routes.py | Health check `/health` and logs `/api/logs` (blueprint: system_bp) |

### backend/
| File | Description |
|------|-------------|
| app.py | Flask entry point, ConfigLoader class, registers all blueprints |
| llm_factory.py | Protocol-aware LLM factory (openai/anthropic, LangChain or raw HTTP) |
| mcp_client.py | MCP protocol client (exports: MCPClient) |
| requirements.txt | Python deps: Flask, LangChain, LangGraph, python-docx, PyPDF2, etc. |

### electron/
| File | Description |
|------|-------------|
| main.js | Electron main process, window management, IPC handlers, spawns Flask |
| flask-launcher.js | Flask subprocess launcher with dynamic port allocation |
| api-server.js | API server for packaged mode serving Next.js output |
| preload.js | IPC bridge exposing window.electronAPI (model configs, MCP, agent dir picker) |

### types/
| File | Description |
|------|-------------|
| electron.d.ts | TypeScript definitions for window.electronAPI (incl. selectDirectory, getHomeDir, validateDirectory) |
| html-docx-js.d.ts | Types for html-docx-js library |

## Configuration Files

- `package.json` — Node.js deps and scripts
- `tsconfig.json` — TypeScript compiler (strict mode, @ alias to project root)
- `tailwind.config.ts` — Tailwind CSS configuration
- `next.config.ts` — Next.js configuration
- `vitest.config.ts` — Vitest test configuration
- `electron-builder.json` — Electron Builder packaging config
- `eslint.config.mjs` — ESLint configuration
- `backend/config/providers.json` — Read-only provider templates (apiUrl, models, protocol)
- `backend/mcp_config.json` — MCP server definitions
- `backend/config/search_config.json` — Search provider settings
- `backend/config/image_config.json` — Image service settings
- `userData/standard-models.json` — Standard API model configs
- `userData/coding-plan-models.json` — Coding Plan model configs (Kimi K2.5)
- `userData/custom-models.json` — Custom model configs (migrated from model-configs.json)

## Key Patterns

**Streaming Responses:**
- Flask/pi-agent backend → SSE `data: {...}\n\n` format
- Frontend: `ReadableStream` + `TextDecoder`; protocol-agnostic
- Message types: `content`, `complete`, `error`, `tool_use`, `citation` (chat); `agent_start`, `tool_call`, `tool_result`, `agent_end` (pi-agent)

**API URL Construction:**
- Always use `buildApiUrl(endpoint)` from `@/lib/apiConfig` — handles dev/prod/Electron

**Multi-Type Model Configs:**
- Three discriminated union types: `standard` | `codingPlan` | `custom`
- Type guards: `isStandardModel(m)`, `isCodingPlanModel(m)`, `isCustomModel(m)`
- Factory: `getLLMConfigFromModel(m)` → `call_config` for backend

**LangGraph Workflows:**
- State: TypedDict; graph: StateGraph with named nodes
- Stream with `astream_events()` for real-time UI updates
- Use `llm_factory.create_llm_client(call_config)` — never instantiate ChatOpenAI/ChatAnthropic directly

**Pi-Agent Tools:**
- Always use `createAgentTools(workDir)` from `lib/agentTools.ts`
- Tools: read, bash, edit, write, grep, find, ls — all bound to workDir

**i18n:**
- `useLanguage()` → locale; `getDictionary(locale)` → typed string map
- Dictionaries in `lib/i18n/dictionaries.ts` (EN/ZH)

**Desktop Packaging:**
- `npm run bundle:python` first, then `npm run build:desktop`
- Python embedded in `python-embed/`; Flask spawned as subprocess with dynamic port
