# Project Index: AIDocMaster

> Auto-generated by project-indexer | Last updated: 2026-02-24

## Project Overview

- **Type:** Fullstack Desktop Application
- **Languages:** TypeScript (60%), Python (40%)
- **Frameworks:** Next.js 16, React 19, Flask 3.0, LangChain, LangGraph, Electron 28
- **Entry Points:** `app/page.tsx`, `backend/app.py`, `electron/main.js`
- **Purpose:** AI-powered document creation, editing, and intelligent assistant with multi-agent orchestration

## Feature Map

### Multi-Agent AI System (`backend/agent/`)
Entry: `backend/agent/agent_router.py`
- LangGraph-powered agent orchestration for intelligent document creation and modification
- **Key exports:**
  - `AgentRouter.route_to_agent()` - Routes user requests to appropriate agent (AutoWriter or DocumentModifier)
  - `AutoWriterAgent` - Generates documents from scratch with multi-step workflow
  - `DocumentModifierAgent` - Intelligently modifies existing documents
  - `DocumentTools` - Tools for searching and modifying document paragraphs
  - `AgentState` - TypedDict state structure for LangGraph workflows

### UI Components (`components/`)
Entry: `components/Container.tsx`
- React UI components for taskbar-based multi-task interface
- **Key components:**
  - `Taskbar` - Vertical navigation with task icons
  - `AIChatContainer` - Multi-conversation chat interface with streaming
  - `AIAutoWriterContainer` - Document generation from natural language
  - `AIDocValidationContainer` - Document editor with AI modification
  - `SettingsDialog` - Application settings modal
  - `SettingsContainer` - Full-page settings with sidebar navigation
  - `WordEditorPanel` - TipTap WYSIWYG editor
  - `ChatMessage` - Message display with markdown and syntax highlighting
  - `MCPToolSelector` - MCP tool selection for chat context

### Next.js API Routes (`app/api/`)
Entry: `app/api/chat/route.ts`
- Proxy layer between frontend and Flask backend with streaming support
- **Key routes:**
  - `/api/chat` - Stream chat messages with LLM
  - `/api/agent-validation` - Validate/modify documents
  - `/api/auto-writer` - Generate documents from scratch
  - `/api/agent-route` - Intelligent agent routing
  - `/api/models` - LLM model configuration CRUD

### Utility Libraries (`lib/`)
Entry: `lib/apiConfig.ts`
- Shared utilities and configuration clients
- **Key exports:**
  - `buildApiUrl(endpoint)` - Builds API URLs for dev/prod/Electron environments
  - `getLLMConfig()` - Gets user-configured LLM settings
  - `logger` - Custom structured logging utility
  - `chatStorage` - LocalStorage-based chat history persistence
  - `modelConfig` - Model configuration client
  - `mcpConfig` - MCP server configuration
  - `cn(classes)` - Tailwind class merging utility
  - `LanguageProvider` / `useLanguage()` - i18n context for EN/ZH localization
  - `getDictionary(locale)` - Returns typed translation dictionary

### Backend Domain Services (`backend/domains/`)
Entry: `backend/app.py`
- Domain-Driven Design (DDD) architecture with Flask blueprints
- **Domains:**
  - `chat/` - Chat with LLM and streaming SSE responses
  - `agent/` - Agent routing and execution
  - `document/` - Document parsing (Word, PDF) and processing
  - `model/` - LLM model configuration (stored in config/models.json)
  - `mcp/` - Model Context Protocol server management
  - `image_service/` - Image generation service integration
  - `search_service/` - Web search provider integration
  - `system/` - System health and status

### Electron Desktop Packaging (`electron/`)
Entry: `electron/main.js`
- Desktop application main process with Flask subprocess management
- **Key exports:**
  - `main.js` - Electron main process, spawns Flask backend
  - `flask-launcher.js` - Flask subprocess launcher with dynamic port
  - `api-server.js` - API server for packaged mode
  - `preload.js` - Electron preload script for IPC bridge

## Module Dependencies

**Frontend:**
- `components` → `lib` (uses logger, apiConfig, chatClient, modelConfig)
- `app/api` → `lib` (uses apiConfig to proxy to Flask)
- `app/page.tsx` → `components` (imports Container with all feature components)

**Backend:**
- `domains` → `agent` (uses AgentRouter, AutoWriterAgent, DocumentModifierAgent)
- `agent` → `mcp_client` (uses MCP for external tool integration)
- `agent` → (LangChain, LangGraph for workflows)
- `app.py` → `domains` (registers all domain blueprints)

**Desktop:**
- `electron/main.js` → `backend/app.py` (spawns Flask subprocess)
- `electron/main.js` → `out/` (serves Next.js production build)

## File Index

### components/
| File | Description |
|------|-------------|
| Container.tsx | Main app container with taskbar and feature switching |
| Taskbar.tsx | Vertical navigation bar with task icons (interface: Task, TaskbarProps) |
| AIChatContainer.tsx | Multi-conversation chat interface with streaming responses |
| AIAutoWriterContainer.tsx | Document auto-generation from natural language prompts |
| AIDocValidationContainer.tsx | Document editor with AI-powered modification |
| ChatMessage.tsx | Message display with markdown, syntax highlighting, citations |
| ChatInput.tsx | Chat input with file attachment and MCP tool selection |
| ChatStopButton.tsx | Stop button for streaming responses |
| WordEditorPanel.tsx | TipTap WYSIWYG editor for document editing |
| SettingsContainer.tsx | Full-page settings with sidebar navigation and section panels |
| SettingsDialog.tsx | Settings modal with tabbed panels |
| ModelSettingsPanel.tsx | LLM model configuration panel |
| MCPSettingsPanel.tsx | MCP server configuration panel |
| MCPToolSelector.tsx | Multi-select MCP tool selector for chat |
| MCPToolExecutionDisplay.tsx | MCP tool execution results display |
| SearchServiceSettingsPanel.tsx | Web search provider configuration |
| ImageServiceSettingsPanel.tsx | Image generation service configuration |
| DisplaySettingsPanel.tsx | UI display preferences |
| ConversationList.tsx | Chat conversation sidebar with search |
| NewConversationDialog.tsx | New conversation creation dialog |
| ChatBotManager.tsx | Chat bot configuration and management |
| ValidationResultPanel.tsx | Agent validation results display |
| AgentStatusPanel.tsx | Agent execution status and progress |
| AgentListDialog.tsx | Available agents list dialog |
| ImageInsertDialog.tsx | Image insertion dialog for editor |
| ImageEditor.tsx | Image editing and manipulation |
| ImageEditorPanel.tsx | Image editor panel container |
| RewriteComparisonView.tsx | Side-by-side comparison for rewrites |
| TextSelectionToolbar.tsx | Floating toolbar for text selection |
| TextCheckResultView.tsx | Text validation results display |
| NetworkSearchToggle.tsx | Toggle for web search in chat |
| NetworkSearchExecutionDisplay.tsx | Web search results display |
| FloatingChatButton.tsx | Floating chat button overlay |
| ConfirmDialog.tsx | Confirmation dialog component |
| ErrorDialog.tsx | Error display dialog |
| InfoDialog.tsx | Information dialog component |
| ContextMenu.tsx | Right-click context menu |
| ChatDialog.tsx | Chat dialog modal |
| ChatPanel.tsx | Chat panel container |
| Header.tsx | Application header with title and actions |
| Footer.tsx | Application footer |
| LanguageSwitcher.tsx | Language switching (EN/ZH) |
| ChatErrorDisplay.tsx | Chat error message display |
| FileAttachment.tsx | File attachment display and handling |

### app/
| File | Description |
|------|-------------|
| page.tsx | Main application page with Container component |
| layout.tsx | Root layout with theme provider and i18n setup |
| globals.css | Global CSS variables and Tailwind base styles |
| api/chat/route.ts | Chat API proxy to Flask backend with SSE streaming |
| api/agent-validation/route.ts | Document validation agent API proxy |
| api/auto-writer/route.ts | Document auto-writer agent API proxy |
| api/agent-route/route.ts | Agent routing API proxy |
| api/models/route.ts | Model configuration CRUD API |
| api/agents/route.ts | Agent list and info API |
| api/document-validation/route.ts | Document validation API |
| api/text-processing/route.ts | Text processing API |

### lib/
| File | Description |
|------|-------------|
| apiConfig.ts | API URL builder for dev/prod/Electron environments (exports: buildApiUrl, getApiBaseUrl, checkApiServerAvailability) |
| chatClient.ts | LLM chat client with streaming support (exports: ChatMessage, LLMConfig, getLLMConfig, validateLLMConfig) |
| logger.ts | Custom structured logging utility (exports: logger with info, error, debug, success, component methods) |
| utils.ts | Utility functions (exports: cn - Tailwind class merger) |
| chatStorage.ts | LocalStorage-based chat history persistence (exports: saveConversations, loadConversations, deleteConversation) |
| modelConfig.ts | Model configuration client (exports: getDefaultModel, saveModels, loadModels, getLLMConfigFromModel) |
| modelConfigServer.ts | Server-side model config sync (exports: syncModelsToServer) |
| modelConfigSync.ts | Model config synchronization utilities |
| mcpConfig.ts | MCP server configuration (exports: loadMCPConfig, saveMCPConfig, getMCPServers) |
| imageServiceConfig.ts | Image service configuration (exports: loadImageConfig, saveImageConfig) |
| searchServiceConfig.ts | Search service configuration (exports: loadSearchConfig, saveSearchConfig) |
| displayConfig.ts | Display settings configuration (exports: loadDisplayConfig, saveDisplayConfig) |
| chatBotConfig.ts | Chat bot configuration (exports: loadChatBotConfig, saveChatBotConfig) |
| flaskConfig.ts | Flask backend configuration utilities |
| documentUtils.ts | Document processing utilities (exports: parseWordDocument, exportToWord) |
| wordExport.ts | Word document export with formatting (exports: exportToDocx) |
| textProcessingApi.ts | Text processing API client (exports: processText, checkGrammar) |
| highlightExtension.ts | TipTap highlight extension |
| highlightUtils.ts | Syntax highlighting utilities |
| imageExtension.ts | TipTap image extension with resize |
| i18n/config.ts | i18next configuration (exports: i18n instance) |
| i18n/dictionaries.ts | Translation dictionaries (EN/ZH) (exports: getDictionary, Dictionary type) |
| i18n/LanguageContext.tsx | Language context provider and hook (exports: LanguageProvider, useLanguage) |

### backend/agent/
| File | Description |
|------|-------------|
| agent_router.py | Routes requests to appropriate agent (exports: AgentRouter, AUTO_WRITER_AGENT, DOCUMENT_MODIFIER_AGENT) |
| auto_writer_agent.py | Generates documents from scratch using LangGraph (exports: AutoWriterAgent, create_auto_writer_graph) |
| document_agent.py | Modifies existing documents using LangGraph (exports: DocumentAgent, create_document_agent_graph) |
| writer_intent.py | Intent detection for auto-writer (exports: WriterIntent, extract_writer_intent) |
| tools.py | Document manipulation tools (exports: DocumentTools with search_document_paragraphs, modify_document_paragraph) |
| prompts.py | LLM prompts for agents (exports: ROUTER_PROMPT, AUTO_WRITER_PROMPT, DOCUMENT_MODIFIER_PROMPT) |
| state.py | Agent state definitions (exports: AgentState, TodoItem) |
| __init__.py | Agent module initialization |

### backend/domains/
| Domain | Routes | Description |
|--------|--------|-------------|
| chat/ | routes.py | Chat with LLM, streaming SSE responses (blueprint: chat_bp) |
| agent/ | routes.py | Agent routing and execution (blueprint: agent_bp) |
| document/ | routes.py, parser.py | Document parsing (Word, PDF) and processing (blueprint: document_bp) |
| model/ | routes.py | LLM model configuration CRUD (blueprint: model_bp) |
| mcp/ | routes.py | MCP server management (blueprint: mcp_bp) |
| image_service/ | routes.py | Image generation service integration (blueprint: image_service_bp) |
| search_service/ | routes.py | Web search provider integration (blueprint: search_service_bp) |
| system/ | routes.py | System health and status (blueprint: system_bp) |

### backend/
| File | Description |
|------|-------------|
| app.py | Flask application entry point, registers all domain blueprints |
| mcp_client.py | Model Context Protocol client for external tool integration (exports: MCPClient) |
| requirements.txt | Python dependencies (Flask, LangChain, LangGraph, python-docx, etc.) |

### electron/
| File | Description |
|------|-------------|
| main.js | Electron main process, spawns Flask backend subprocess |
| flask-launcher.js | Flask subprocess launcher with dynamic port allocation |
| api-server.js | API server for packaged mode |
| api-server-new.js | Alternative API server implementation |
| preload.js | Electron preload script for IPC bridge (exposes electronAPI) |

### types/
| File | Description |
|------|-------------|
| electron.d.ts | TypeScript definitions for Electron IPC (Window.electronAPI interface) |
| html-docx-js.d.ts | TypeScript definitions for html-docx-js library |

## Configuration Files

- `package.json` - Node.js dependencies and scripts
- `tsconfig.json` - TypeScript compiler configuration
- `tailwind.config.ts` - Tailwind CSS configuration
- `next.config.ts` - Next.js configuration
- `vitest.config.ts` - Vitest test configuration
- `electron-builder.json` - Electron Builder packaging configuration
- `eslint.config.mjs` - ESLint configuration
- `postcss.config.mjs` - PostCSS configuration

## Backend Configuration

- `backend/config/models.json` - LLM model configurations (managed via Settings UI)
- `backend/mcp_config.json` - MCP server definitions
- `backend/config/search_config.json` - Search provider settings
- `backend/config/image_config.json` - Image service settings

## Testing

- `components/__tests__/` - Vitest component tests using @testing-library/react
- `backend/tests/` - pytest tests for Python backend

## Build & Scripts

- `scripts/bundle-python.js` - Creates python-embed directory with dependencies
- `scripts/build-desktop.js` - Orchestrates Next.js build + Electron Builder
- `scripts/verify-desktop-setup.js` - Pre-build validation
- `scripts/fix-packaged-dependencies.js` - Post-package dependency fixes
- `scripts/fix-electron-paths.js` - Converts absolute asset paths to relative for Electron file:// protocol

## Key Patterns

**Streaming Responses:**
- Backend uses Flask SSE with `data: {...}\n\n` format
- Frontend uses ReadableStream with TextDecoder to parse SSE
- Message types: `content`, `complete`, `error`, `tool_use`, `citation`

**API URL Construction:**
- Always use `buildApiUrl()` from `@/lib/apiConfig`
- Handles dev (localhost:3000) vs prod vs Electron (dynamic port) environments

**Logging:**
- Frontend: Use `logger` from `@/lib/logger` (not console.log)
- Backend: Use Python `logging` module with structured extra fields

**State Management:**
- React hooks (useState, useEffect, useCallback, useRef)
- LocalStorage for persistence (chat history, settings)
- No global state library

**LangGraph Workflows:**
- Define state with TypedDict
- Use StateGraph with clear node definitions
- Stream with `astream_events()` for real-time UI updates

**Desktop Packaging:**
- Python backend bundled in `python-embed/`
- Flask spawned as subprocess in Electron main process
- Dynamic port allocation with IPC communication
